<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ POS ç³»çµ± (ç°¡åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f4f4f5; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .menu-card { transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #e5e7eb; }
        .menu-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .menu-card-unavailable { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; background-color: #f3f4f6; }
        .order-item-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #14b8a6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10 flex-shrink-0">
        <h1 class="text-xl md:text-2xl font-bold text-gray-800">ç°¡æ˜“é»é¤ç³»çµ±</h1>
        <div class="text-right">
            <p id="currentTime" class="font-medium text-gray-700"></p>
        </div>
    </header>

    <div id="pos-main-view" class="flex-1 flex flex-col md:flex-row overflow-hidden hidden">
        <!-- Menu -->
        <main id="menu-grid-container" class="menu-grid flex-1 p-4 overflow-y-auto">
            <!-- Menu cards will be dynamically inserted here -->
        </main>

        <!-- Order Summary -->
        <aside class="w-full md:w-2/5 lg:w-1/3 bg-white p-4 flex flex-col shadow-lg border-l border-gray-200">
            <h2 class="text-xl font-bold border-b pb-2 mb-4">ç›®å‰è¨‚å–®</h2>
            <div id="order-items-container" class="flex-1 overflow-y-auto">
                <p id="empty-order-message" class="text-gray-400 text-center mt-10">è«‹å¾å·¦å´é»é¤</p>
            </div>
            <div class="flex-shrink-0 border-t pt-4 mt-4 space-y-4">
                <div class="flex justify-between font-bold text-2xl text-gray-800">
                    <span>ç¸½è¨ˆ</span>
                    <span id="total-price">NT$ 0</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="clear-order-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition">æ¸…ç©º</button>
                    <button id="send-order-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:opacity-50" disabled>é€å‡ºè¨‚å–®</button>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Loading/Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div id="message-modal-content" class="bg-white rounded-lg p-8 shadow-xl text-center">
            <!-- Content will be injected by JS -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let menuItems = [];
        let currentOrder = [];
        
        const LOAD_DATA_URL = 'https://hook.us2.make.com/7x1uvc1swnt7oyijv35fuwl253esfl95';
        const SEND_ORDER_URL = 'https://hook.us2.make.com/piom613s1yzoba3wx06gfviwnwv56aah';

        let hasInitialized = false;

        // DOM Elements
        const posMainView = document.getElementById('pos-main-view');
        const menuGridContainer = document.getElementById('menu-grid-container');
        const orderItemsContainer = document.getElementById('order-items-container');
        const emptyOrderMessage = document.getElementById('empty-order-message');
        const totalPriceEl = document.getElementById('total-price');
        const sendOrderBtn = document.getElementById('send-order-btn');
        const clearOrderBtn = document.getElementById('clear-order-btn');
        const currentTimeEl = document.getElementById('currentTime');
        const messageModal = document.getElementById('message-modal');
        const messageModalContent = document.getElementById('message-modal-content');

        const showMessage = (type, message, duration = 0) => {
            messageModal.classList.remove('hidden');
            let content = '';
            if (type === 'loading') {
                content = `<div class="loader"></div><p class="mt-4 text-gray-600">${message}</p>`;
            } else if (type === 'success') {
                content = `<div class="text-green-500"><svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><p class="mt-4 text-lg font-semibold">${message}</p>`;
            }
            messageModalContent.innerHTML = content;
            if (duration > 0) {
                setTimeout(() => messageModal.classList.add('hidden'), duration);
            }
        };
        
        const renderMenu = () => {
            menuGridContainer.innerHTML = '';
            menuItems.forEach(item => {
                const isAvailable = item.producible > 0;
                const card = document.createElement('div');
                card.className = `menu-card bg-white rounded-lg shadow p-3 flex flex-col items-center justify-between text-center cursor-pointer ${!isAvailable ? 'menu-card-unavailable' : ''}`;
                if (isAvailable) card.addEventListener('click', () => addItemToOrder(item));
                card.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800">${item.name}</h3>
                        <p class="text-sm text-gray-600">NT$ ${item.salePrice}</p>
                    </div>
                    <div class="mt-2 text-xs font-bold ${isAvailable ? 'text-green-600' : 'text-red-600'}">
                        ${isAvailable ? `å¯é» ${item.producible} ä»½` : 'å·²å”®å®Œ'}
                    </div>`;
                menuGridContainer.appendChild(card);
            });
        };

        const renderOrder = () => {
            orderItemsContainer.innerHTML = '';
            emptyOrderMessage.classList.toggle('hidden', currentOrder.length > 0);
            sendOrderBtn.disabled = currentOrder.length === 0;
            
            let total = 0;
            currentOrder.forEach(orderItem => {
                const item = menuItems.find(c => c.id === orderItem.id);
                if (!item) return; // Skip if item not found
                total += item.salePrice * orderItem.quantity;
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center py-2 border-b order-item-enter';
                itemEl.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-500">NT$ ${item.salePrice}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="quantity-change-btn bg-gray-200 rounded-full w-6 h-6 font-bold" data-id="${item.id}" data-change="-1">-</button>
                        <span class="w-6 text-center">${orderItem.quantity}</span>
                        <button class="quantity-change-btn bg-gray-200 rounded-full w-6 h-6 font-bold" data-id="${item.id}" data-change="1">+</button>
                    </div>
                    <button class="remove-item-btn ml-2 text-gray-400 hover:text-red-500" data-id="${item.id}">ğŸ—‘ï¸</button>`;
                orderItemsContainer.appendChild(itemEl);
            });
            totalPriceEl.textContent = `NT$ ${total}`;
        };

        const addItemToOrder = (item) => {
            const existingItem = currentOrder.find(orderItem => orderItem.id === item.id);
            if (existingItem) {
                if (existingItem.quantity < item.producible) existingItem.quantity++;
            } else {
                currentOrder.push({ id: item.id, quantity: 1 });
            }
            renderOrder();
        };
        
        const handleOrderChange = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const itemId = target.dataset.id;
            if (!itemId) return;

            if (target.classList.contains('quantity-change-btn')) {
                const change = parseInt(target.dataset.change, 10);
                const orderItem = currentOrder.find(item => item.id === itemId);
                const menuItem = menuItems.find(item => item.id === itemId);
                if (orderItem && menuItem) {
                    const newQuantity = orderItem.quantity + change;
                    if (newQuantity > 0 && newQuantity <= menuItem.producible) {
                        orderItem.quantity = newQuantity;
                    } else if (newQuantity <= 0) {
                        currentOrder = currentOrder.filter(item => item.id !== itemId);
                    }
                }
            } else if (target.classList.contains('remove-item-btn')) {
                currentOrder = currentOrder.filter(item => item.id !== itemId);
            }
            renderOrder();
        };

        const clearOrder = () => { currentOrder = []; renderOrder(); };
        
        const sendOrder = async () => { 
            const orderData = {
                orderTime: new Date().toISOString(),
                items: currentOrder.map(item => {
                    const menuItem = menuItems.find(m => m.id === item.id);
                    return { id: item.id, name: menuItem ? menuItem.name : 'æœªçŸ¥å“é …', quantity: item.quantity };
                }),
                total: parseInt(totalPriceEl.textContent.replace('NT$ ', ''), 10)
            };
            
            console.log("--- è¨‚å–®æº–å‚™é€å‡º ---", JSON.stringify(orderData, null, 2));
            showMessage('loading', 'è¨‚å–®å‚³é€ä¸­...');
            try {
                const response = await fetch(SEND_ORDER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                showMessage('success', 'è¨‚å–®å·²æˆåŠŸé€å‡ºï¼', 2000);
                clearOrder();
            } catch (error) {
                console.error("å‚³é€è¨‚å–®å¤±æ•—:", error);
                showMessage('success', 'å‚³é€å¤±æ•—(æ¨¡æ“¬æˆåŠŸ)', 2000); // Fallback for demo
                clearOrder();
            }
        };
        
        const updateTime = () => { currentTimeEl.textContent = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }); };

        const startApp = () => {
            posMainView.classList.remove('hidden');
            renderMenu();
            renderOrder();
            updateTime();
            setInterval(updateTime, 1000);
        };

        async function initializePOS() {
            if(hasInitialized) return;
            hasInitialized = true;

            showMessage('loading', 'æ­£åœ¨å¾ Notion è¼‰å…¥æœ€æ–°èœå–®...');
            try {
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Request timed out')), 10000));
                const fetchPromise = fetch(LOAD_DATA_URL);
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (data && data[0] && Array.isArray(data[0].body)) {
                    menuItems = data[0].body.map(item => {
                        const props = item.properties_value || {};
                        return {
                            id: item.id,
                            name: props['é¤é»åç¨±']?.[0]?.plain_text || 'æœªå‘½å',
                            salePrice: props['åƒ¹æ ¼']?.number || 0,
                            category: props['é¤é»é¡å‹']?.select?.name || 'æœªåˆ†é¡',
                            producible: props['å¯ä¾›æ‡‰åº«å­˜é‡']?.rollup?.number ?? 0
                        };
                    });
                } else {
                    throw new Error("Webhookå›å‚³çš„è³‡æ–™çµæ§‹ç„¡æ•ˆã€‚");
                }
                
                messageModal.classList.add('hidden');
                
            } catch (error) {
                console.error("ç„¡æ³•å¾ Make.com è¼‰å…¥è³‡æ–™:", error);
                 showMessage('success', 'è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é›¢ç·šç¯„ä¾‹è³‡æ–™', 2000);
                 menuItems = [
                    { id: 'MENU-01', name: 'æ‰“æ‹‹è±¬è‚‰é£¯', salePrice: 150, category: 'ä¸»é£Ÿ', producible: 10 },
                    { id: 'MENU-02', name: 'æ³°å¼ç¶ å’–å“©é›é£¯', salePrice: 260, category: 'ä¸»é£Ÿ', producible: 5 },
                    { id: 'MENU-03', name: 'æµ·é®®é…¸è¾£æ¹¯', salePrice: 180, category: 'æ¹¯å“', producible: 8 },
                    { id: 'MENU-04', name: 'æœˆäº®è¦é¤…', salePrice: 250, category: 'ç‰¹è‰²å–®é»', producible: 0 },
                    { id: 'MENU-05', name: 'æ³°å¼å¥¶èŒ¶', salePrice: 80, category: 'é£²å“', producible: 20 },
                ];
            } finally {
                startApp();
            }
        }

        // Event Listeners
        orderItemsContainer.addEventListener('click', handleOrderChange);
        clearOrderBtn.addEventListener('click', clearOrder);
        sendOrderBtn.addEventListener('click', sendOrder);

        initializePOS();
    });
    </script>
</body>
</html>
