<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ POS ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals & Subtle Teal Accent -->
    <!-- Application Structure Plan: æœ¬æ‡‰ç”¨æ¡ç”¨ä¸€å€‹ç¶“å…¸çš„é›™æ¬„å¼POSä»‹é¢ã€‚å·¦å´æ˜¯ä¸»è¦çš„ã€Œèœå–®ç¶²æ ¼ã€ï¼Œä»¥è¦–è¦ºåŒ–çš„å¡ç‰‡å±•ç¤ºæ‰€æœ‰é¤é»ï¼Œé€™æ˜¯ä¸»è¦çš„é»é¤å€åŸŸã€‚å³å´æ˜¯ã€Œè¨‚å–®æ‘˜è¦ã€å´é‚Šæ¬„ï¼Œå³æ™‚é¡¯ç¤ºç•¶å‰è¨‚å–®çš„å“é …ã€æ•¸é‡ã€å°è¨ˆèˆ‡ç¸½é‡‘é¡ï¼Œä¸¦æä¾›çµå¸³èˆ‡æ¸…ç©ºè¨‚å–®çš„æ“ä½œæŒ‰éˆ•ã€‚æ­¤çµæ§‹çš„æ ¸å¿ƒäº®é»åœ¨æ–¼ã€Œèœå–®ç¶²æ ¼ã€çš„å‹•æ…‹æ€§ï¼šç³»çµ±æœƒåœ¨è¼‰å…¥æ™‚ï¼Œæ ¹æ“šæˆ‘å€‘ä¹‹å‰è¨è«–çš„éè¿´ logiqueï¼Œå³æ™‚è¨ˆç®—æ¯å€‹é¤é»çš„ã€Œå¯è£½ä½œä»½æ•¸ã€ã€‚å¯éŠ·å”®çš„é¤é»æœƒæ­£å¸¸é¡¯ç¤ºï¼Œè€Œå› åŸæ–™ä¸è¶³è€Œç„¡æ³•è£½ä½œçš„é¤é»å‰‡æœƒä»¥ç°è‰²é¡¯ç¤ºä¸”ç„¡æ³•é»æ“Šã€‚é€™å€‹è¨­è¨ˆå°‡å¾Œç«¯è¤‡é›œçš„åº«å­˜æ•¸æ“šï¼Œè½‰åŒ–ç‚ºå‰å ´äººå“¡æœ€ç›´è§€ã€æœ€ä¸æ˜“å‡ºéŒ¯çš„æ“ä½œé«”é©—ã€‚ -->
    <!-- Visualization & Content Choices: 
        - Report Info: é¤å»³çš„æœ€çµ‚èœè‰²åˆ—è¡¨åŠå…¶åƒ¹æ ¼ã€‚ -> Goal: Organize/Select -> Viz: äº’å‹•å¼å¡ç‰‡ç¶²æ ¼ (HTML/CSS)ã€‚ -> Interaction: é»æ“Šå¡ç‰‡å°‡é¤é»åŠ å…¥è¨‚å–®ã€‚ -> Justification: é€™æ˜¯è§¸æ§å¼POSç³»çµ±æœ€ç›´è§€ã€æœ€å¿«é€Ÿçš„é»é¤æ–¹å¼ã€‚
        - Report Info: æ ¹æ“šåº«å­˜è¨ˆç®—å‡ºçš„ã€Œå¯è£½ä½œä»½æ•¸ã€ã€‚ -> Goal: Inform/Warn -> Viz: CSSæ¨£å¼ï¼ˆç°éšï¼‰èˆ‡æç¤ºæ¨™ç±¤ã€‚ -> Interaction: ç„¡æ³•é»æ“Šå·²å”®å®Œçš„é …ç›®ã€‚ -> Justification: ç›´æ¥åœ¨æ“ä½œä»‹é¢ä¸­é˜²æ­¢éŠ·å”®ç„¡æ³•ä¾›æ‡‰çš„é¤é»ï¼Œå¾æºé ­é¿å…å®¢è¨´ã€‚
        - Report Info: ç•¶å‰è¨‚å–®çš„å…§å®¹èˆ‡ç¸½åƒ¹ã€‚ -> Goal: Summarize/Confirm -> Viz: æ¢åˆ—å¼æ¸…å–®ã€‚ -> Interaction: å¯èª¿æ•´æ•¸é‡æˆ–ç§»é™¤å“é …ã€‚ -> Justification: æä¾›æ¸…æ™°çš„è¨‚å–®é è¦½ï¼Œæ–¹ä¾¿èˆ‡é¡§å®¢ç¢ºèªä¸¦é€²è¡Œä¿®æ”¹ï¼Œæ˜¯POSç³»çµ±çš„æ¨™æº–åŠŸèƒ½ã€‚
        - Report Info: éŠ·å”®äº‹ä»¶ã€‚ -> Goal: Action -> Viz: ã€Œçµå¸³ã€æŒ‰éˆ•ã€‚ -> Interaction: é»æ“Šå¾Œæ¨¡æ“¬çµå¸³æµç¨‹ã€‚ -> Justification: å®Œæˆæ•´å€‹éŠ·å”®é–‰ç’°çš„æ ¸å¿ƒæ“ä½œã€‚
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f4f4f5; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .menu-card { transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #e5e7eb; }
        .menu-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .menu-card-unavailable { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; background-color: #f3f4f6; }
        .order-item-enter { animation: slideIn 0.3s ease-out forwards; }
        .category-btn.active { background-color: #14b8a6; color: white; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .modal-content { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .table-card { transition: all 0.2s ease-in-out; }
        .table-card-occupied { background-color: #fffbeb; border-color: #f59e0b; }
        .table-card-confirmed { background-color: #fef2f2; border-color: #ef4444; }
        /* Mobile Order Summary Transition */
        #mobile-order-summary.translate-y-full { transform: translateY(100%); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10 flex-shrink-0">
        <div>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Tanawat POS</h1>
            <p id="table-display" class="text-sm text-gray-500 font-semibold">æœªé¸æ“‡æ¡Œè™Ÿ</p>
        </div>
        <div class="flex items-center space-x-4">
             <button id="change-table-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition">é¸æ“‡æ¡Œä½</button>
            <div class="text-right hidden sm:block">
                <p id="currentTime" class="font-medium text-gray-700"></p>
                <p class="text-sm text-gray-500">æ“ä½œå“¡: åº—é•·</p>
            </div>
        </div>
    </header>

    <div id="pos-main-view" class="flex-1 flex overflow-hidden hidden">
        <!-- Left: Menu -->
        <main class="flex-1 p-4 flex flex-col overflow-hidden">
            <div id="category-filter-container" class="flex-shrink-0 flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
            <div id="menu-grid-container" class="menu-grid flex-1 overflow-y-auto"></div>
        </main>

        <!-- Right: Order Summary (Desktop) -->
        <aside class="w-full md:w-2/5 lg:w-1/3 bg-white p-4 flex-col shadow-lg border-l border-gray-200 hidden md:flex">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-xl font-bold">è¨‚å–®æ‘˜è¦</h2>
                <span id="order-status-badge" class="px-3 py-1 text-xs font-semibold rounded-full hidden"></span>
            </div>
            <div id="order-items-container" class="flex-1 overflow-y-auto">
                <p id="empty-order-message" class="text-gray-400 text-center mt-10">è«‹å¾å·¦å´é»é¤</p>
            </div>
            <div class="flex-shrink-0 border-t pt-4 mt-4 space-y-4">
                <div>
                    <label for="desktop-order-notes" class="text-sm font-medium text-gray-700">è¨‚å–®å‚™è¨»</label>
                    <textarea id="desktop-order-notes" class="order-notes-input mt-1 w-full p-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="ä¾‹å¦‚ï¼šå°‘å†°ã€ä¸è¦é¦™èœ..."></textarea>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span>å°è¨ˆ</span><span id="subtotal-price">NT$ 0</span></div>
                    <div class="flex justify-between"><span>æœå‹™è²» (5%)</span><span id="service-charge">NT$ 0</span></div>
                </div>
                <div class="flex justify-between font-bold text-2xl text-gray-800">
                    <span>ç¸½è¨ˆ</span>
                    <span id="total-price">NT$ 0</span>
                </div>
                <div id="action-buttons" class="grid grid-cols-2 gap-2"></div>
            </div>
        </aside>
    </div>
    
    <!-- Mobile Floating Action Button -->
    <div id="mobile-fab" class="fixed bottom-4 right-4 z-20 md:hidden">
        <button id="view-order-btn" class="bg-teal-600 text-white rounded-full p-4 shadow-lg flex items-center justify-center">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span id="mobile-order-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
        </button>
    </div>

    <!-- Mobile Order Summary -->
    <div id="mobile-order-summary" class="fixed inset-0 bg-white z-40 flex flex-col transition-transform duration-300 ease-in-out translate-y-full md:hidden">
        <header class="flex-shrink-0 flex items-center justify-between p-4 border-b">
            <h2 class="text-xl font-bold">è¨‚å–®æ‘˜è¦</h2>
            <button id="close-mobile-order-btn">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </header>
        <div id="mobile-order-items-container" class="flex-1 overflow-y-auto p-4"></div>
        <footer class="p-4 border-t space-y-4 bg-gray-50 flex-shrink-0">
             <div>
                <label for="mobile-order-notes" class="text-sm font-medium text-gray-700">è¨‚å–®å‚™è¨»</label>
                <textarea id="mobile-order-notes" class="order-notes-input mt-1 w-full p-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="ä¾‹å¦‚ï¼šå°‘å†°ã€ä¸è¦é¦™èœ..."></textarea>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span>å°è¨ˆ</span><span id="mobile-subtotal-price">NT$ 0</span></div>
                <div class="flex justify-between"><span>æœå‹™è²» (5%)</span><span id="mobile-service-charge">NT$ 0</span></div>
            </div>
            <div class="flex justify-between font-bold text-2xl text-gray-800">
                <span>ç¸½è¨ˆ</span>
                <span id="mobile-total-price">NT$ 0</span>
            </div>
            <div id="mobile-action-buttons" class="grid grid-cols-2 gap-2"></div>
        </footer>
    </div>

    <!-- Table Selection Modal -->
    <div id="table-selection-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-lg md:max-w-4xl modal-content">
            <h3 class="text-2xl font-bold mb-6 text-center">è«‹é¸æ“‡æ¡Œä½</h3>
            <div id="table-grid-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4"></div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl w-full max-w-md modal-content">
            <h3 class="text-2xl font-bold mb-2 text-center">çµå¸³</h3>
            <p class="text-center text-gray-500 mb-6">è¨‚å–®ç¸½é‡‘é¡: <span id="modal-total" class="font-bold text-lg"></span></p>
            <div class="space-y-4">
                <div>
                    <label class="font-semibold">ä»˜æ¬¾æ–¹å¼</label>
                    <div class="mt-2 grid grid-cols-2 gap-4">
                        <button data-payment="cash" class="payment-method-btn border-2 border-teal-500 bg-teal-50 text-teal-700 font-semibold py-3 rounded-lg">ç¾é‡‘</button>
                        <button data-payment="card" class="payment-method-btn border border-gray-300 text-gray-600 font-semibold py-3 rounded-lg">ä¿¡ç”¨å¡</button>
                    </div>
                </div>
                <div id="cash-payment-section">
                    <label for="cash-received" class="font-semibold">æ”¶å–ç¾é‡‘</label>
                    <input type="number" id="cash-received" class="w-full mt-2 p-3 border border-gray-300 rounded-lg text-center text-xl" placeholder="è¼¸å…¥é¡§å®¢æ”¯ä»˜é‡‘é¡">
                    <p class="mt-2 text-center">æ‡‰æ‰¾é›¶: <span id="change-due" class="font-bold text-2xl text-red-500">NT$ 0</span></p>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                <button id="cancel-checkout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">å–æ¶ˆ</button>
                <button id="confirm-payment-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg disabled:opacity-50" disabled>ç¢ºèªæ”¶æ¬¾</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const components = [
            { id: 'H01', name: 'è±¬çµè‚‰', type: 'åŸºç¤é£Ÿæ', stock: 5000 }, { id: 'B26', name: 'å¤§è¾£æ¤’', type: 'åŸºç¤é£Ÿæ', stock: 800 },
            { id: 'C09', name: 'æ³°åœ‹èŒ‰è‰é¦™ç±³', type: 'åŸºç¤é£Ÿæ', stock: 25000 }, { id: 'F02', name: 'èª¿è£½æ‰“æ‹‹é†¬', type: 'åŠæˆå“', stock: 1500 },
            { id: 'MENU-01', name: 'æ‰“æ‹‹è±¬è‚‰é£¯', type: 'æœ€çµ‚èœè‰²', salePrice: 150, category: 'ä¸»é£Ÿ' }, { id: 'D04', name: 'å»éª¨è…¿æ’', type: 'åŸºç¤é£Ÿæ', stock: 12000 },
            { id: 'C26', name: 'ç¶ å’–å“©(æœ‰å¿ƒ)', type: 'åŸºç¤é£Ÿæ', stock: 500 }, { id: 'C16', name: 'æ¤°å¥¶(AROY-D)', type: 'åŸºç¤é£Ÿæ', stock: 14000 },
            { id: 'MENU-02', name: 'æ³°å¼ç¶ å’–å“©é›é£¯', type: 'æœ€çµ‚èœè‰²', salePrice: 260, category: 'ä¸»é£Ÿ' }, { id: 'E01', name: 'ç™½è¦', type: 'åŸºç¤é£Ÿæ', stock: 2000 },
            { id: 'L07', name: 'é…¸è¾£æ¹¯å¡Š', type: 'åŸºç¤é£Ÿæ', stock: 528 }, { id: 'MENU-03', name: 'æµ·é®®é…¸è¾£æ¹¯', type: 'æœ€çµ‚èœè‰²', salePrice: 180, category: 'æ¹¯å“' },
            { id: 'K01', name: 'é›è›‹', type: 'åŸºç¤é£Ÿæ', stock: 100 }, { id: 'MENU-04', name: 'æœˆäº®è¦é¤…', type: 'æœ€çµ‚èœè‰²', salePrice: 250, category: 'ç‰¹è‰²å–®é»' },
            { id: 'C13', name: 'æ‰‹æ¨™ç´…èŒ¶ç²‰', type: 'åŸºç¤é£Ÿæ', stock: 4000 }, { id: 'A14', name: 'ç…‰ä¹³', type: 'åŸºç¤é£Ÿæ', stock: 2000 },
            { id: 'MENU-05', name: 'æ³°å¼å¥¶èŒ¶', type: 'æœ€çµ‚èœè‰²', salePrice: 80, category: 'é£²å“' },
        ];
        const structure = [
            { parent: 'F02', child: 'H01', quantity: 200 }, { parent: 'F02', child: 'B26', quantity: 50 }, { parent: 'MENU-01', child: 'F02', quantity: 100 },
            { parent: 'MENU-01', child: 'C09', quantity: 200 }, { parent: 'MENU-02', child: 'D04', quantity: 150 }, { parent: 'MENU-02', child: 'C26', quantity: 50 },
            { parent: 'MENU-02', child: 'C16', quantity: 100 }, { parent: 'MENU-02', child: 'C09', quantity: 200 }, { parent: 'MENU-03', child: 'E01', quantity: 100 },
            { parent: 'MENU-03', child: 'L07', quantity: 50 }, { parent: 'MENU-04', child: 'E01', quantity: 150 }, { parent: 'MENU-04', child: 'K01', quantity: 1 },
            { parent: 'MENU-05', child: 'C13', quantity: 20 }, { parent: 'MENU-05', child: 'A14', quantity: 15 },
        ];
        const tables = ['A1', 'A2', 'A3', 'A4', 'B1', 'B2', 'B3', 'B4', 'C1', 'C2', 'C3', 'C4'];

        let state = { orders: {}, activeTable: null, activeCategory: 'all', orderHistory: [] };

        const findComponentById = id => components.find(c => c.id === id);
        const memoizedProducible = new Map();
        const calculateProducibleQuantity = (componentId) => {
            if (memoizedProducible.has(componentId)) return memoizedProducible.get(componentId);
            const component = findComponentById(componentId);
            if (!component) return 0;
            if (component.type === 'åŸºç¤é£Ÿæ' || component.type === 'åŠæˆå“') return component.stock;
            const composition = structure.filter(s => s.parent === componentId);
            if (composition.length === 0) return Infinity;
            const producibleQuantities = composition.map(item => Math.floor(calculateProducibleQuantity(item.child) / item.quantity));
            const result = Math.min(...producibleQuantities);
            memoizedProducible.set(componentId, result);
            return result;
        };
        const recalculateAllProducible = () => {
            memoizedProducible.clear();
            components.forEach(c => c.producible = calculateProducibleQuantity(c.id));
        };
        recalculateAllProducible();

        // DOM Elements
        const posMainView = document.getElementById('pos-main-view');
        const menuGridContainer = document.getElementById('menu-grid-container');
        const categoryFilterContainer = document.getElementById('category-filter-container');
        const tableSelectionModal = document.getElementById('table-selection-modal');
        const tableGridContainer = document.getElementById('table-grid-container');
        const tableDisplay = document.getElementById('table-display');
        const changeTableBtn = document.getElementById('change-table-btn');
        const currentTimeEl = document.getElementById('currentTime');
        const checkoutModal = document.getElementById('checkout-modal');
        const mobileFab = document.getElementById('mobile-fab');
        const viewOrderBtn = document.getElementById('view-order-btn');
        const mobileOrderSummary = document.getElementById('mobile-order-summary');
        const closeMobileOrderBtn = document.getElementById('close-mobile-order-btn');
        const cashReceivedInput = document.getElementById('cash-received');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');

        // Order Summary Elements (Desktop & Mobile)
        const orderElements = {
            desktop: {
                container: document.getElementById('order-items-container'),
                emptyMsg: document.getElementById('empty-order-message'),
                subtotal: document.getElementById('subtotal-price'),
                serviceCharge: document.getElementById('service-charge'),
                total: document.getElementById('total-price'),
                actions: document.getElementById('action-buttons'),
                statusBadge: document.getElementById('order-status-badge'),
                notes: document.getElementById('desktop-order-notes')
            },
            mobile: {
                container: document.getElementById('mobile-order-items-container'),
                subtotal: document.getElementById('mobile-subtotal-price'),
                serviceCharge: document.getElementById('mobile-service-charge'),
                total: document.getElementById('mobile-total-price'),
                actions: document.getElementById('mobile-action-buttons'),
                count: document.getElementById('mobile-order-count'),
                notes: document.getElementById('mobile-order-notes')
            }
        };

        const renderTableSelection = () => {
            tableGridContainer.innerHTML = tables.map(tableId => {
                const order = state.orders[tableId];
                const isOccupied = order && order.items.length > 0;
                let total = 0;
                let statusClass = '';
                if(isOccupied) {
                    const subtotal = order.items.reduce((sum, item) => sum + (findComponentById(item.id).salePrice * item.quantity), 0);
                    total = subtotal + Math.round(subtotal * 0.05);
                    statusClass = order.status === 'confirmed' ? 'table-card-confirmed' : 'table-card-occupied';
                }
                return `<div data-table-id="${tableId}" class="table-card text-center p-4 border-2 rounded-lg cursor-pointer ${statusClass}"><div class="font-bold text-xl">${tableId}</div><div class="text-xs text-gray-500">${isOccupied ? `NT$ ${total}` : 'ç©ºæ¡Œ'}</div></div>`;
            }).join('');
        };

        const renderCategories = () => {
            const categories = ['all', ...new Set(components.filter(c => c.type === 'æœ€çµ‚èœè‰²' && c.category).map(c => c.category))];
            categoryFilterContainer.innerHTML = categories.map(cat => `<button data-category="${cat}" class="category-btn px-4 py-2 text-sm font-semibold rounded-lg transition border ${state.activeCategory === cat ? 'active' : 'bg-white'}">${cat === 'all' ? 'å…¨éƒ¨' : cat}</button>`).join('');
        };
        
        const renderMenu = () => {
            menuGridContainer.innerHTML = '';
            const menuItems = components.filter(c => c.type === 'æœ€çµ‚èœè‰²' && (state.activeCategory === 'all' || c.category === state.activeCategory));
            menuItems.forEach(item => {
                const isAvailable = item.producible > 0;
                const card = document.createElement('div');
                card.className = `menu-card bg-white rounded-lg shadow p-3 flex flex-col items-center justify-between text-center cursor-pointer ${!isAvailable ? 'menu-card-unavailable' : ''}`;
                if (isAvailable) card.addEventListener('click', () => addItemToOrder(item));
                card.innerHTML = `<div><h3 class="font-semibold text-gray-800">${item.name}</h3><p class="text-sm text-gray-600">NT$ ${item.salePrice}</p></div><div class="mt-2 text-xs font-bold ${isAvailable ? 'text-green-600' : 'text-red-600'}">${isAvailable ? `å¯è£½ä½œ ${item.producible} ä»½` : 'åº«å­˜ä¸è¶³'}</div>`;
                menuGridContainer.appendChild(card);
            });
        };

        const renderOrder = () => {
            const order = state.orders[state.activeTable];
            const currentOrderItems = order ? order.items : [];
            const orderStatus = order ? order.status : 'pending';
            const orderNotes = order ? order.notes : '';

            const updateSummary = (elements) => {
                if (elements.statusBadge) {
                    if (orderStatus === 'confirmed') {
                        elements.statusBadge.textContent = 'å·²é€å‡º';
                        elements.statusBadge.className = 'px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800';
                        elements.statusBadge.classList.remove('hidden');
                    } else {
                        elements.statusBadge.classList.add('hidden');
                    }
                }
                
                if (elements.notes) {
                    elements.notes.value = orderNotes;
                    elements.notes.disabled = orderStatus === 'confirmed';
                }

                if (elements.container) {
                    elements.container.innerHTML = '';
                    if (elements.emptyMsg) elements.emptyMsg.classList.toggle('hidden', currentOrderItems.length > 0);
                    currentOrderItems.forEach(orderItem => {
                        const item = findComponentById(orderItem.id);
                        const itemEl = document.createElement('div');
                        const isConfirmed = orderStatus === 'confirmed';
                        itemEl.className = `flex justify-between items-center py-2 border-b order-item-enter ${isConfirmed ? 'opacity-70' : ''}`;
                        itemEl.innerHTML = `<div class="flex-1"><p class="font-medium">${item.name}</p><p class="text-sm text-gray-500">NT$ ${item.salePrice}</p></div><div class="flex items-center space-x-2"><button class="quantity-change-btn bg-gray-200 rounded-full w-6 h-6 font-bold" data-id="${item.id}" data-change="-1" ${isConfirmed ? 'disabled' : ''}>-</button><span class="w-6 text-center">${orderItem.quantity}</span><button class="quantity-change-btn bg-gray-200 rounded-full w-6 h-6 font-bold" data-id="${item.id}" data-change="1" ${isConfirmed ? 'disabled' : ''}>+</button></div><button class="remove-item-btn ml-2 text-gray-400 hover:text-red-500" data-id="${item.id}" ${isConfirmed ? 'disabled' : ''}>ğŸ—‘ï¸</button>`;
                        elements.container.appendChild(itemEl);
                    });
                }

                let subtotal = currentOrderItems.reduce((sum, item) => sum + (findComponentById(item.id).salePrice * item.quantity), 0);
                const serviceCharge = Math.round(subtotal * 0.05);
                const total = subtotal + serviceCharge;
                elements.subtotal.textContent = `NT$ ${subtotal}`;
                elements.serviceCharge.textContent = `NT$ ${serviceCharge}`;
                elements.total.textContent = `NT$ ${total}`;
                if (elements.count) elements.count.textContent = currentOrderItems.length;
            };

            updateSummary(orderElements.desktop);
            updateSummary(orderElements.mobile);
            renderActionButtons();
        };

        const renderActionButtons = () => {
            const order = state.orders[state.activeTable];
            const hasItems = order && order.items.length > 0;
            const isConfirmed = order && order.status === 'confirmed';

            const createButtons = (container) => {
                if (isConfirmed) {
                    container.innerHTML = `<button id="add-more-btn" class="w-full col-span-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition">åŠ é»</button><button id="checkout-btn" class="w-full col-span-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition">çµå¸³</button>`;
                } else {
                    container.innerHTML = `<button id="clear-order-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition">æ¸…ç©ºè¨‚å–®</button><button id="send-order-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:opacity-50" ${!hasItems ? 'disabled' : ''}>é€å‡ºè¨‚å–®</button>`;
                }
            };
            createButtons(orderElements.desktop.actions);
            createButtons(orderElements.mobile.actions);
        };

        const addItemToOrder = (item) => {
            if (!state.activeTable) return;
            const order = state.orders[state.activeTable];
            if (order && order.status === 'confirmed') { alert('è¨‚å–®å·²é€å‡ºè‡³å»šæˆ¿ï¼Œè«‹ä½¿ç”¨ã€ŒåŠ é»ã€åŠŸèƒ½ä¿®æ”¹è¨‚å–®ã€‚'); return; }
            if (!order) state.orders[state.activeTable] = { items: [], status: 'pending', notes: '' };
            const currentOrderItems = state.orders[state.activeTable].items;
            const existingItem = currentOrderItems.find(orderItem => orderItem.id === item.id);
            if (existingItem) {
                if (existingItem.quantity < item.producible) existingItem.quantity++;
            } else {
                currentOrderItems.push({ id: item.id, quantity: 1 });
            }
            renderOrder();
        };
        
        const handleOrderChange = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const itemId = target.dataset.id;
            if (!itemId || !state.activeTable) return;
            const order = state.orders[state.activeTable];
            if (!order || order.status === 'confirmed') return;
            let currentOrderItems = order.items;
            if (target.classList.contains('quantity-change-btn')) {
                const change = parseInt(target.dataset.change, 10);
                const orderItem = currentOrderItems.find(item => item.id === itemId);
                const componentItem = findComponentById(itemId);
                if (orderItem) {
                    const newQuantity = orderItem.quantity + change;
                    if (newQuantity > 0 && newQuantity <= componentItem.producible) {
                        orderItem.quantity = newQuantity;
                    } else if (newQuantity <= 0) {
                        order.items = currentOrderItems.filter(item => item.id !== itemId);
                    }
                }
            } else if (target.classList.contains('remove-item-btn')) {
                order.items = currentOrderItems.filter(item => item.id !== itemId);
            }
            renderOrder();
        };

        const clearOrder = () => { if (state.activeTable) { state.orders[state.activeTable] = { items: [], status: 'pending', notes: '' }; renderOrder(); } };
        
        const sendOrder = () => { 
            if (state.activeTable) { 
                const order = state.orders[state.activeTable];
                order.status = 'confirmed';
                
                const orderDataForKitchen = {
                    tableId: state.activeTable,
                    orderTime: new Date().toISOString(),
                    items: order.items.map(item => ({ id: item.id, name: findComponentById(item.id).name, quantity: item.quantity })),
                    notes: order.notes
                };
                
                console.log("--- è¨‚å–®å·²é€å‡ºè‡³å»šæˆ¿ ---");
                console.log(JSON.stringify(orderDataForKitchen, null, 2));
                state.orderHistory.push(orderDataForKitchen);
                
                renderOrder(); 
            } 
        };
        
        const unlockOrder = () => { if (state.activeTable) { state.orders[state.activeTable].status = 'pending'; renderOrder(); } };

        const openCheckout = () => {
            const order = state.orders[state.activeTable];
            if (!order || order.items.length === 0) return;
            const total = parseInt(orderElements.desktop.total.textContent.replace('NT$ ', '')) || parseInt(orderElements.mobile.total.textContent.replace('NT$ ', ''));
            modalTotalEl.textContent = `NT$ ${total}`;
            cashReceivedInput.value = '';
            changeDueEl.textContent = 'NT$ 0';
            confirmPaymentBtn.disabled = true;
            checkoutModal.classList.remove('hidden');
        };
        const closeCheckout = () => { checkoutModal.classList.add('hidden'); };
        const confirmPayment = () => {
            console.log(`Order for table ${state.activeTable} paid:`, state.orders[state.activeTable].items);
            const orderItems = state.orders[state.activeTable].items;
            orderItems.forEach(orderItem => deductStock(orderItem.id, orderItem.quantity));
            recalculateAllProducible();
            delete state.orders[state.activeTable];
            closeCheckout();
            showTableSelection();
        };

        const deductStock = (componentId, quantity) => {
            const component = findComponentById(componentId);
            if (!component) return;
            if (component.type === 'åŸºç¤é£Ÿæ' || component.type === 'åŠæˆå“') {
                component.stock -= quantity;
            } else {
                const composition = structure.filter(s => s.parent === componentId);
                composition.forEach(item => deductStock(item.child, item.quantity * quantity));
            }
        };

        const updateTime = () => { currentTimeEl.textContent = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }); };
        const showTableSelection = () => {
            state.activeTable = null;
            tableDisplay.textContent = 'æœªé¸æ“‡æ¡Œè™Ÿ';
            posMainView.classList.add('hidden');
            mobileFab.classList.add('hidden');
            renderTableSelection();
            tableSelectionModal.classList.remove('hidden');
        };
        const selectTable = (tableId) => {
            state.activeTable = tableId;
            tableDisplay.textContent = `æ¡Œè™Ÿ: ${tableId}`;
            if (!state.orders[tableId]) state.orders[state.activeTable] = { items: [], status: 'pending', notes: '' };
            tableSelectionModal.classList.add('hidden');
            posMainView.classList.remove('hidden');
            mobileFab.classList.remove('hidden');
            renderOrder();
            renderCategories();
            renderMenu();
        };

        // Event Listeners Setup
        tableGridContainer.addEventListener('click', e => { const card = e.target.closest('.table-card'); if (card) selectTable(card.dataset.tableId); });
        changeTableBtn.addEventListener('click', showTableSelection);
        categoryFilterContainer.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                state.activeCategory = e.target.dataset.category;
                renderCategories();
                renderMenu();
            }
        });
        
        document.body.addEventListener('input', e => {
            if (e.target.classList.contains('order-notes-input')) {
                if (state.activeTable && state.orders[state.activeTable]) {
                    state.orders[state.activeTable].notes = e.target.value;
                }
            }
        });

        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const button = target.closest('button');
            if (!button) return;

            if(button.closest('#action-buttons') || button.closest('#mobile-action-buttons')) {
                if(button.id === 'clear-order-btn') clearOrder();
                if(button.id === 'send-order-btn') sendOrder();
                if(button.id === 'add-more-btn') unlockOrder();
                if(button.id === 'checkout-btn') openCheckout();
            }
            if(button.closest('#order-items-container') || button.closest('#mobile-order-items-container')) {
                handleOrderChange(e);
            }
            if(button.id === 'cancel-checkout-btn') closeCheckout();
            if(button.id === 'confirm-payment-btn') confirmPayment();
            if(button.classList.contains('payment-method-btn')) {
                document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('border-2', 'border-teal-500', 'bg-teal-50', 'text-teal-700'));
                button.classList.add('border-2', 'border-teal-500', 'bg-teal-50', 'text-teal-700');
            }
        });

        cashReceivedInput.addEventListener('input', () => {
            const modalTotalEl = document.getElementById('modal-total');
            const changeDueEl = document.getElementById('change-due');
            const total = parseInt(modalTotalEl.textContent.replace('NT$ ', ''), 10);
            const received = parseInt(cashReceivedInput.value, 10) || 0;
            const change = received - total;
            changeDueEl.textContent = `NT$ ${change >= 0 ? change : 0}`;
            confirmPaymentBtn.disabled = received < total;
        });
        
        viewOrderBtn.addEventListener('click', () => mobileOrderSummary.classList.remove('translate-y-full'));
        closeMobileOrderBtn.addEventListener('click', () => mobileOrderSummary.classList.add('translate-y-full'));

        showTableSelection();
        updateTime();
        setInterval(updateTime, 1000);
    });
    </script>
</body>
</html>
