<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廚房顯示系統 (KDS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .ticket-fade-out { animation: fadeOut 0.5s ease-out forwards; }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <header class="bg-gray-800 shadow-md p-4 sticky top-0 z-10">
        <h1 id="header-title" class="text-2xl font-bold text-center">廚房製作單顯示 (連線中...)</h1>
    </header>

    <main id="ticket-container" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        <!-- Firestore orders will be inserted here -->
    </main>

    <script type="module">
        // 引入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 元素 ---
        const ticketContainer = document.getElementById('ticket-container');
        const headerTitle = document.getElementById('header-title');

        // --- Firebase 相關變數 ---
        let db;
        let auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let ordersUnsubscribe = null; // 用於儲存監聽器以便後續取消

        // --- 應用程式狀態 ---
        let orders = []; // 本地訂單快照

        // --- Firebase 初始化 ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("KDS Firebase initialized and user signed in.");
                headerTitle.textContent = '廚房製作單顯示 (已連線)';
                listenToOrders(); // 開始監聽訂單
            } catch (error) {
                console.error("KDS Firebase initialization failed:", error);
                headerTitle.textContent = '廚房製作單顯示 (連線失敗)';
            }
        }

        // --- 監聽 Firestore 訂單 ---
        function listenToOrders() {
            if (!db) return;
            const collectionPath = `/artifacts/${appId}/public/data/kds_orders`;
            const q = query(collection(db, collectionPath));

            if (ordersUnsubscribe) ordersUnsubscribe(); // 如果已有監聽，先取消

            ordersUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const newOrders = [];
                querySnapshot.forEach((doc) => {
                    const orderData = doc.data();
                    // 將 Firestore timestamp 轉換為 JavaScript Date 物件
                    const timestamp = orderData.timestamp?.toDate() || new Date();
                    newOrders.push({
                        firestoreId: doc.id, // 保存 Firestore 文件 ID 以便刪除
                        ...orderData,
                        timestamp: timestamp.getTime()
                    });
                });
                orders = newOrders;
                renderAllTickets();
            }, (error) => {
                console.error("Error listening to orders:", error);
                headerTitle.textContent = '廚房製作單顯示 (監聽錯誤)';
            });
        }
        
        // --- 渲染畫面 ---
        function renderAllTickets() {
            // 根據時間戳由舊到新排序
            orders.sort((a, b) => a.timestamp - b.timestamp);
            ticketContainer.innerHTML = ''; // 清空容器
            if (orders.length === 0) {
                 ticketContainer.innerHTML = `<p class="text-gray-400 text-center col-span-full mt-10 text-xl">目前沒有待製作的訂單</p>`;
            } else {
                orders.forEach(order => {
                    const ticketElement = createTicketElement(order);
                    ticketContainer.appendChild(ticketElement);
                });
            }
        }

        function createTicketElement(order) {
            const ticket = document.createElement('div');
            // 保存 firestoreId 到 dataset
            ticket.dataset.firestoreId = order.firestoreId;
            ticket.className = 'bg-gray-800 rounded-lg shadow-lg flex flex-col h-full';

            const timeElapsed = Math.floor((Date.now() - order.timestamp) / 1000);
            const minutes = Math.floor(timeElapsed / 60);
            const seconds = timeElapsed % 60;
            
            let borderColorClass = 'border-yellow-500';
            let textColorClass = 'text-yellow-400';
            if (minutes >= 10) {
                borderColorClass = 'border-red-500';
                textColorClass = 'text-red-400';
            }

            const header = `
                <div class="bg-gray-700 p-3 rounded-t-lg flex justify-between items-center border-b-4 ${borderColorClass}">
                    <div>
                        <p class="text-xl font-bold">桌號: ${order.table}</p>
                        <p class="text-xs text-gray-400">單號: ${order.orderId}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold ${textColorClass}" data-timestamp="${order.timestamp}">${minutes}<span class="text-base">分</span>${seconds.toString().padStart(2, '0')}<span class="text-base">秒</span></p>
                        <p class="text-xs text-gray-400">已下單</p>
                    </div>
                </div>
            `;

            const itemsList = order.items.map(item => {
                const mods = item.mods && item.mods.length > 0
                    ? `<ul class="pl-6 text-sm text-yellow-300">${item.mods.map(mod => `<li>- ${mod}</li>`).join('')}</ul>`
                    : '';
                return `
                    <li class="py-3 px-3 border-b border-gray-700 cursor-pointer hover:bg-gray-700/50 transition-colors duration-200 item-toggle">
                        <p class="text-lg font-semibold">${item.qty}x ${item.name}</p>
                        ${mods}
                    </li>
                `;
            }).join('');

            ticket.innerHTML = `
                ${header}
                <ul class="flex-grow overflow-y-auto">${itemsList}</ul>
                <div class="p-2 mt-auto">
                    <button class="complete-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200">
                        完成此單
                    </button>
                </div>
            `;
            return ticket;
        }

        // 更新所有卡片計時器
        function updateTimers() {
            document.querySelectorAll('[data-timestamp]').forEach(timer => {
                const timestamp = parseInt(timer.dataset.timestamp, 10);
                const timeElapsed = Math.floor((Date.now() - timestamp) / 1000);
                const minutes = Math.floor(timeElapsed / 60);
                const seconds = timeElapsed % 60;
                
                if (minutes >= 10 && !timer.classList.contains('text-red-400')) {
                    timer.parentElement.parentElement.classList.replace('border-yellow-500', 'border-red-500');
                    timer.classList.replace('text-yellow-400', 'text-red-400');
                }
                
                timer.innerHTML = `${minutes}<span class="text-base">分</span>${seconds.toString().padStart(2, '0')}<span class="text-base">秒</span>`;
            });
        }

        // --- 事件處理 ---
        ticketContainer.addEventListener('click', async (e) => {
            // 處理項目點擊事件 (劃掉)
            if (e.target.closest('.item-toggle')) {
                const itemElement = e.target.closest('.item-toggle');
                itemElement.classList.toggle('line-through');
                itemElement.classList.toggle('text-gray-500');
                itemElement.classList.toggle('bg-gray-900/50');
            }

            // 處理完成按鈕點擊事件
            if (e.target.closest('.complete-btn')) {
                const ticketElement = e.target.closest('[data-firestore-id]');
                if (!ticketElement || !db) return;

                const firestoreIdToRemove = ticketElement.dataset.firestoreId;
                
                // 添加淡出動畫
                ticketElement.classList.add('ticket-fade-out');
                
                // 直接從 Firestore 刪除，onSnapshot 會自動更新 UI
                try {
                    const collectionPath = `/artifacts/${appId}/public/data/kds_orders`;
                    await deleteDoc(doc(db, collectionPath, firestoreIdToRemove));
                    console.log(`Order ${firestoreIdToRemove} completed and deleted.`);
                } catch (error) {
                    console.error("Failed to delete order:", error);
                    // 如果刪除失敗，移除動畫讓卡片重新可見
                    ticketElement.classList.remove('ticket-fade-out');
                }
            }
        });

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);
        setInterval(updateTimers, 1000); // 每秒更新計時器
    </script>
</body>
</html>
